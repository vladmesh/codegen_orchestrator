# ะัะดะธั ัะตัะฒะธัะฐ LangGraph

**ะะฐัะฐ:** 2025-12-30
**ะะฑะฝะพะฒะปะตะฝะพ:** 2025-12-31
**ะกัะฐััั:** ะ ะฟัะพัะตััะต ัะตัะฐะบัะพัะธะฝะณะฐ

## ะัะพะณัะตัั

| ะะฐะดะฐัะฐ | ะกัะฐััั | ะะฐัะฐ |
|--------|--------|------|
| 7.2. ะฆะตะฝััะฐะปะธะทะพะฒะฐัั ะบะพะฝััะฐะฝัั | โ ะัะฟะพะปะฝะตะฝะพ | 2024-12-30 |
| 7.3. ะะฐะทะฑะธัั ProvisionerNode.run() | โ ะัะฟะพะปะฝะตะฝะพ | 2024-12-30 |
| 7.1. ะัะฝะตััะธ prov isioner ะฒ ะพัะดะตะปัะฝัะน ัะตัะฒะธั | โ ะัะฟะพะปะฝะตะฝะพ | 2025-12-30 |
| 7.4. ะัะดะตะปะธัั ToolExecutor ะธะท LLMNode | โ ะัะฟะพะปะฝะตะฝะพ | 2025-12-30 |
| 7.5. ะฃัััะฐะฝะธัั ัะธะบะปะธัะตัะบะธะต ะธะผะฟะพััั | โ ะัะฟะพะปะฝะตะฝะพ | 2025-12-30 |
| 7.8. ะะตะบะพะผะฟะพะทะธัะพะฒะฐัั worker.py | โ ะัะฟะพะปะฝะตะฝะพ | 2025-12-31 |
| 7.6. ะะพะฑะฐะฒะธัั ัะธะฟะธะทะฐัะธั | โ ะัะฟะพะปะฝะตะฝะพ | 2025-12-31 |
| 7.7. ะะตัะธัั TODO/FIXME | โ ะัะฟะพะปะฝะตะฝะพ | 2025-12-31 |

---

## ะะตะทัะผะต

ะกะตัะฒะธั langgraph ัะฒะปัะตััั ัะฐะผัะผ ะฑะพะปััะธะผ ะธ ัะปะพะถะฝัะผ ะบะพะผะฟะพะฝะตะฝัะพะผ ัะธััะตะผั (14,588 ัััะพะบ, 106 Python ัะฐะนะปะพะฒ). ะัะฝะพะฒะฝัะต ะฟัะพะฑะปะตะผั:

1. **ะขัะถัะปัะต ะทะฐะฒะธัะธะผะพััะธ** โ ansible-core ะฒัััะพะตะฝ ะฒ ัะตัะฒะธั, ัะพัั ะธัะฟะพะปัะทัะตััั ัะพะปัะบะพ ะบะฐะบ CLI
2. **ะะฐัััะตะฝะธะต SRP** โ provisioner ะปะพะณะธะบะฐ ะฝะต ะพัะฝะพัะธััั ะบ LLM ะพัะบะตัััะฐัะธะธ
3. **ะะพะปััะธะต ัะฐะนะปั** โ 6 ัะฐะนะปะพะฒ ะฟัะตะฒััะฐัั 400 ัััะพะบ
4. **ะัะฑะปะธัะพะฒะฐะฝะธะต ะบะพะดะฐ** โ hardcoded ะฟััะธ, ะฟะพะฒัะพััััะฐััั ะปะพะณะธะบะฐ SSH/HTTP
5. **God-objects** โ ะบะปะฐััั ั ะธะทะฑััะพัะฝะพะน ะพัะฒะตัััะฒะตะฝะฝะพัััั

---

## 1. ะกัััะบัััะฐ ัะตัะฒะธัะฐ

```
langgraph/src/           # 14,588 ัััะพะบ
โโโ graph.py             # 642 ัััะพะบ - ะะปะฐะฒะฝัะน ะณัะฐั
โโโ worker.py            # 534 ัััะพะบ - Worker ะพะฑัะฐะฑะพัะบะธ
โโโ session_manager.py   # 221 ัััะพะบ
โ
โโโ nodes/               # LLM ัะทะปั ะณัะฐัะฐ
โ   โโโ base.py          # 383 ัััะพะบ - God-object
โ   โโโ architect.py     # 210 ัััะพะบ
โ   โโโ ...
โ
โโโ provisioner/         # ะะ ะะขะะะกะะขะกะฏ ะ LLM!
โ   โโโ node.py          # 489 ัััะพะบ (!)
โ   โโโ ansible_runner.py
โ   โโโ ssh.py
โ   โโโ recovery.py      # 213 ัััะพะบ
โ
โโโ subgraphs/
โ   โโโ devops.py        # 596 ัััะพะบ
โ   โโโ engineering.py   # 312 ัััะพะบ
โ
โโโ tools/               # 11 ัะฐะนะปะพะฒ
โ   โโโ activation.py    # 324 ัััะพะบ
โ   โโโ devops_tools.py  # 263 ัััะพะบ
โ   โโโ ...
โ
โโโ clients/             # API ะบะปะธะตะฝัั
โ   โโโ api.py
โ   โโโ infra_client.py  # 277 ัััะพะบ - SSH ะปะพะณะธะบะฐ
โ   โโโ ...
โ
โโโ capabilities/        # ะกะธััะตะผะฐ ะฒะพะทะผะพะถะฝะพััะตะน
    โโโ base.py          # 337 ัััะพะบ
```

---

## 2. ะัะธัะธัะตัะบะธะต ะฟัะพะฑะปะตะผั

### 2.1. ansible-core ะฒ LangGraph ัะตัะฒะธัะต

**ะัะพะฑะปะตะผะฐ:** ะขัะถัะปะฐั ะทะฐะฒะธัะธะผะพััั ansible-core (43 ััะฐะฝะทะธัะธะฒะฝัั ะฟะฐะบะตัะฐ, ~40 MB) ะฝะฐัะพะดะธััั ะฒ langgraph, ัะพัั:
- ะัะฟะพะปัะทัะตััั ัะพะปัะบะพ ะบะฐะบ CLI ะบะพะผะฐะฝะดะฐ `ansible-playbook` ัะตัะตะท subprocess
- Python ะผะพะดัะปะธ ansible ะะ ะธะผะฟะพััะธัััััั
- ะะต ะธะผะตะตั ะพัะฝะพัะตะฝะธั ะบ LLM ะพัะบะตัััะฐัะธะธ

**ะะตััะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
- `src/provisioner/ansible_runner.py:70` โ subprocess.run(["ansible-playbook", ...])
- `src/tools/devops_tools.py:152` โ ะฐะฝะฐะปะพะณะธัะฝัะน ะฒัะทะพะฒ

**ะะตะบะพะผะตะฝะดะฐัะธั:** ะัะฝะตััะธ ะฒ ะพัะดะตะปัะฝัะน `infrastructure-worker` ัะตัะฒะธั.

### 2.2. Provisioner ะฝะต ะพัะฝะพัะธััั ะบ LangGraph

**ะัะพะฑะปะตะผะฐ:** ะะธัะตะบัะพัะธั `src/provisioner/` (8 ัะฐะนะปะพะฒ, ~1,500 ัััะพะบ) ัะพะดะตัะถะธั:
- ะะพะณะธะบั ัะฐะฑะพัั ั Ansible
- SSH ะพะฟะตัะฐัะธะธ
- ะฃะฟัะฐะฒะปะตะฝะธะต ะธะฝัะธะดะตะฝัะฐะผะธ
- Recovery ะปะพะณะธะบั

ะญัะพ **ะธะฝััะฐััััะบัััะฝัะน ะบะพะด**, ะฝะต ะธัะฟะพะปัะทัััะธะน LLM/LangGraph.

**ะะตะบะพะผะตะฝะดะฐัะธั:** ะะตัะตะฝะตััะธ ะฒ ัะตัะฒะธั `infrastructure` ะธะปะธ ัะพะทะดะฐัั ะฝะพะฒัะน `provisioner-worker`.

### 2.3. infra_client.py โ SSH ะปะพะณะธะบะฐ ะฒ LangGraph

**ะคะฐะนะป:** `src/clients/infra_client.py` (277 ัััะพะบ)

ะกะพะดะตัะถะธั:
- `run_ssh_command()` โ 57 ัััะพะบ
- `get_container_status()` โ 58 ัััะพะบ
- `get_container_stats()` โ 56 ัััะพะบ

**ะัะพะฑะปะตะผะฐ:** SSH ะพะฟะตัะฐัะธะธ ะฝะฐ ัะตัะฒะตัะฐั ะฝะต ะดะพะปะถะฝั ะฒัะฟะพะปะฝััััั ะธะท LLM ัะตัะฒะธัะฐ.

---

## 3. ะคะฐะนะปั ััะตะฑัััะธะต ัะตัะฐะบัะพัะธะฝะณะฐ

### 3.1. ะกะปะธัะบะพะผ ะฑะพะปััะธะต ัะฐะนะปั (>400 ัััะพะบ)

| ะคะฐะนะป | ะกััะพะบ | ะัะพะฑะปะตะผะฐ |
|------|-------|----------|
| `graph.py` | 642 | ะัะฝะพะฒะฝะพะน ะณัะฐั, ััะตะฑัะตั ะดะตะบะพะผะฟะพะทะธัะธะธ |
| `subgraphs/devops.py` | 596 | ะะฝะพะณะพ inline ะปะพะณะธะบะธ |
| ~~`worker.py`~~ | ~~534~~ | โ ะะฐะทะฑะธั ะฝะฐ ะผะพะดัะปะธ 2025-12-31 |
| `provisioner/node.py` | 489 | God-method run() ะฝะฐ 215 ัััะพะบ |
| `nodes/base.py` | 383 | God-object ั 3 ะพัะฒะตัััะฒะตะฝะฝะพัััะผะธ |
| `capabilities/base.py` | 337 | ะะพะถะฝะพ ัะฟัะพััะธัั |

### 3.2. God-methods (>50 ัััะพะบ)

| ะะตัะพะด | ะคะฐะนะป | ะกััะพะบ | ะกัะฐััั |
|-------|------|-------|--------|
| ~~`ProvisionerNode.run()`~~ | provisioner/node.py | ~~215~~ โ 50 | โ ะะฐะทะฑะธั |
| `reinstall_and_provision()` | provisioner/node.py:85 | 112 | โณ |
| `handle_provisioning_success()` | provisioner/node.py:197 | 71 | โณ |
| `activate_project()` | tools/activation.py:109 | 70 | โณ |
| `inspect_repository()` | tools/activation.py:179 | 70 | โณ |
| `run_ssh_command()` | clients/infra_client.py:25 | 57 | โณ |

### 3.3. God-objects

**LLMNode** (`nodes/base.py:45-233`) โ 3 ะพัะฒะตัััะฒะตะฝะฝะพััะธ:
1. ะฃะฟัะฐะฒะปะตะฝะธะต ะบะพะฝัะธะณััะฐัะธะตะน (get_config, get_llm, get_system_prompt)
2. ะัะฟะพะปะฝะตะฝะธะต ะธะฝััััะผะตะฝัะพะฒ (execute_tools, _execute_single_tool)
3. ะฃะฟัะฐะฒะปะตะฝะธะต tools_map

**ะะตะบะพะผะตะฝะดะฐัะธั:** ะัะดะตะปะธัั `ToolExecutor` ะฒ ะพัะดะตะปัะฝัะน ะบะปะฐัั.

---

## 4. ะัะฑะปะธัะพะฒะฐะฝะธะต ะบะพะดะฐ

### 4.1. Hardcoded ะฟััะธ (ะดัะฑะปะธัััััั ะฒ 4 ะผะตััะฐั)

```python
# provisioner/recovery.py:43
playbook_path = "/app/services/infrastructure/ansible/playbooks/deploy_project.yml"

# tools/devops_tools.py:152
playbook_path = "/app/services/infrastructure/ansible/playbooks/deploy_project.yml"

# clients/infra_client.py:21
SSH_KEY_PATH = "/root/.ssh/id_ed25519"

# tools/devops_tools.py:19
SSH_KEY_PATH = "/root/.ssh/id_ed25519"
```

### 4.2. ะัะฑะปะธัะพะฒะฐะฝะธะต provisioning ะปะพะณะธะบะธ

`provisioner/node.py` ะธะผะตะตั ะธะดะตะฝัะธัะฝัะน ะบะพะด:
- ะกััะพะบะธ 151-158 ะธ 432-439 โ ะทะฐะฟััะบ Phase 1
- ะกััะพะบะธ 175-181 ะธ 460-466 โ ะทะฐะฟััะบ Phase 2

---

## 5. Code Smells

### 5.1. ~~ะะฐะณะธัะตัะบะธะต ัะธัะปะฐ ะฑะตะท ัะตะฝััะฐะปะธะทะฐัะธะธ~~ โ ะะกะะะะะะะะ

> **ะะตัะตะฝะพ 2024-12-30:** ะัะต ัะฐะนะผะฐััั ัะตะฝััะฐะปะธะทะพะฒะฐะฝั ะฒ `src/config/constants.py`:
> ```python
> class Timeouts:
>     SSH_COMMAND = 30
>     PROVISIONING = 1200
>     REINSTALL = 900
>     PASSWORD_RESET = 300
>     ACCESS_PHASE = 180
>     WORKER_SPAWN = 600
>     PREPARER_SPAWN = 120
>     SERVICE_DEPLOY = 300
> ```

### 5.2. ะกะปะธัะบะพะผ ะพะฑัะธะต except ะฑะปะพะบะธ

```python
# provisioner/node.py:75-82
except Exception as e:  # ะะพะฒะธั ะะกะ
    logger.error(...)
    return None

# tools/github.py:317
except Exception:  # noqa: S110
    pass  # ะะณะฝะพัะธััะตั ะพัะธะฑะบั
```

### 5.3. ะฆะธะบะปะธัะตัะบะธะต ะธะผะฟะพััั (ะพะฑัะพะดะฝัะต ัะตัะตะฝะธั)

```python
# tools/infrastructure.py:44
def some_function():
    from ..capabilities.base import get_current_state  # ะะผะฟะพัั ะฒะฝัััะธ ััะฝะบัะธะธ

# tools/activation.py:127
def another_function():
    from .github import get_github_client  # ะขะพะถะต ะฒะฝัััะธ ััะฝะบัะธะธ
```

### 5.4. ~~Unsafe dict access~~ โ ะะกะะะะะะะะ

> **ะะตัะตะฝะพ 2025-12-31:** ะกะพะทะดะฐะฝ `schemas/api_types.py` ั TypedDict ััะตะผะฐะผะธ
> (`ServerInfo`, `AllocationInfo`, `ProjectInfo`) ะธ helper-ััะฝะบัะธัะผะธ
> (`get_server_ip()`, `get_repo_url()`). ะะฑะฝะพะฒะปะตะฝั 5 ัะฐะนะปะพะฒ ั ัะธะฟะธะทะฐัะธะตะน.

### 5.5. ~~TODO/FIXME ะฒ ะบะพะดะต~~ โ ะะกะะะะะะะะ

> **ะะตัะตะฝะพ 2025-12-31:** ะัะต TODO ัะดะฐะปะตะฝั ะธะปะธ ัะตัะตะฝั:
> - `deploy.py` โ ัะดะฐะปะตะฝั ะฝะตะฐะบััะฐะปัะฝัะต TODO
> - `infrastructure.py` โ ัะตะฐะปะธะทะพะฒะฐะฝะฐ ะฟัะพะฒะตัะบะฐ ownership
> - `engineering.py`, `engineering_worker.py` โ ะฟะตัะตะฝะตัะตะฝั ะฒ backlog

---

## 6. ะัะฑะปะธัะพะฒะฐะฝะธะต ะทะฐะฒะธัะธะผะพััะตะน

**langgraph/pyproject.toml ัะพะดะตัะถะธั 185 ะฟะฐะบะตัะพะฒ** ะฟะพัะปะต ัะฐะทัะตัะตะฝะธั ะทะฐะฒะธัะธะผะพััะตะน.

### ะะฐะฒะธัะธะผะพััะธ, ะบะพัะพััะต ะผะพะถะฝะพ ัะตะฝััะฐะปะธะทะพะฒะฐัั ะฒ shared:

| ะะฐะบะตั | langgraph | api | scheduler | telegram_bot |
|-------|-----------|-----|-----------|--------------|
| structlog | โ | โ | โ | โ |
| redis | โ | โ | โ | โ |
| httpx | โ | โ | โ | โ |
| pydantic | โ | โ | - | โ |
| pyjwt | โ | โ | โ | - |

### ะขัะถัะปัะต ะทะฐะฒะธัะธะผะพััะธ ัะพะปัะบะพ ะฒ langgraph:

| ะะฐะบะตั | ะขัะฐะฝะทะธัะธะฒะฝัั | ะะฐะทะผะตั |
|-------|--------------|--------|
| ansible-core | 43 | ~40 MB |
| langchain | 25 | ~15 MB |
| langgraph | 8 | ~5 MB |

---

## 7. ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ัะตัะฐะบัะพัะธะฝะณั

### ะัะธะพัะธัะตั: ะะะะขะะงะะกะะะ

#### 7.1. ะัะฝะตััะธ provisioner ะฒ ะพัะดะตะปัะฝัะน ัะตัะฒะธั โ

**ะกัะฐััั**: โ ะะะะะะกะขะฌะฎ ะะซะะะะะะะ 2025-12-31

**ะะตะฐะปะธะทะพะฒะฐะฝะพ:**
- ะกะพะทะดะฐะฝ ะฝะพะฒัะน ัะตัะฒะธั `infrastructure-worker`
- ะะตัะตะฝะตััะฝ ะฒะตัั ะบะพะด provisioner ะธะท langgraph
- ะะตัะตะผะตัะตะฝั Ansible playbooks ะธะท `services/infrastructure/ansible`
- ะฃะดะฐะปัะฝ ansible-core ะธะท ะทะฐะฒะธัะธะผะพััะตะน langgraph
- ะกะพะทะดะฐะฝ `provisioner_client.py` ะดะปั ะฐัะธะฝััะพะฝะฝะพะณะพ ะฒะทะฐะธะผะพะดะตะนััะฒะธั ัะตัะตะท Redis
- ะฃะดะฐะปัะฝ ััะฐััะน ัะตัะฒะธั `devops` (ัะฟััะธะน ะบะพะฝัะตะนะฝะตั)
- **ะกะพะทะดะฐะฝ `provisioner_proxy.py` (120 ัััะพะบ)** - ะดะตะปะตะณะธััะตั ะฒ infrastructure-worker
- **ะฃะดะฐะปะตะฝะฐ ะดะธัะตะบัะพัะธั `provisioner/` ะธะท langgraph** (~2,000 ัััะพะบ)
- ะะฑะฝะพะฒะปัะฝ `nodes/__init__.py` ะดะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฟัะพะบัะธ

**ะะตะทัะปััะฐัั:**
- โ ะะฐะทะผะตั langgraph: **597MB** (ะฑัะปะพ ~800MB, **-25.4%**)
- โ ะะฐะทะผะตั infrastructure-worker: 440MB
- โ ะกััะพะบ ะบะพะดะฐ langgraph: **10,939** (ะฑัะปะพ 14,700, **-25.6%**)
- โ ะะฐะฒะธัะธะผะพััะตะน ะฒ langgraph: ~140 ะฟะฐะบะตัะพะฒ (ะฑัะปะพ 185, **-45 ะฟะฐะบะตัะพะฒ**)
- โ ะัะต ัะตััั ะฟัะพัะพะดัั (159 ัะตััะพะฒ)

**ะััะธัะตะบัััะฐ:**
```
langgraph/provisioner_proxy.py (120 ัััะพะบ)
         โ (Redis)
infrastructure-worker/provisioner/ (~2,000 ัััะพะบ)
         โ
      Ansible
```

**ะัะณะพะดะฐ:**
- ะฃะฑัะฐะฝ ansible-core ะธะท langgraph (-40 MB, -43 ะฟะฐะบะตัะฐ)
- ะะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ (SRP)
- ะะตะทะฐะฒะธัะธะผะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต
- **ะะพััะธะณะฝััั ัะตะปะธ: <600MB ะพะฑัะฐะท, <11,000 ัััะพะบ ะบะพะดะฐ** โ

#### 7.2. ~~ะฆะตะฝััะฐะปะธะทะพะฒะฐัั ะบะพะฝััะฐะฝัั~~ โ ะะซะะะะะะะ (2024-12-30)

ะกะพะทะดะฐะฝ `src/config/constants.py` ั ะบะปะฐััะฐะผะธ:
- `Paths` โ SSH_KEY, ANSIBLE_PLAYBOOKS, playbook()
- `Timeouts` โ ะฒัะต ัะฐะนะผะฐััั ั env overrides
- `Provisioning` โ MAX_RETRIES, DEFAULT_OS_TEMPLATE, etc.

ะะฑะฝะพะฒะปะตะฝั ัะฐะนะปั:
- `clients/infra_client.py`
- `clients/worker_spawner.py`
- `clients/preparer_spawner.py`
- `tools/devops_tools.py`
- `provisioner/ansible_runner.py`
- `provisioner/recovery.py`
- `provisioner/node.py`

### ะัะธะพัะธัะตั: ะะซะกะะะะ

#### 7.3. ~~ะะฐะทะฑะธัั ProvisionerNode.run()~~ โ ะะซะะะะะะะ (2024-12-30)

ะะตัะพะด ัะฐะทะฑะธั ะฝะฐ 6 ะฟะพะดะผะตัะพะดะพะฒ:
- `_get_and_validate_server_info()` โ 25 ัััะพะบ
- `_check_max_attempts()` โ 20 ัััะพะบ
- `_init_time4vps_client()` โ 30 ัััะพะบ
- `_should_reinstall()` โ 15 ัััะพะบ
- `_run_reinstall_path()` โ 30 ัััะพะบ
- `_run_existing_access_path()` โ 45 ัััะพะบ
- `run()` โ 50 ัััะพะบ (ะพัะบะตัััะฐัะธั)

#### 7.4. ~~ะัะดะตะปะธัั ToolExecutor ะธะท LLMNode~~ โ ะะซะะะะะะะ (2025-12-30)

**ะะตะฐะปะธะทะพะฒะฐะฝะพ:**
- ะกะพะทะดะฐะฝ `nodes/tool_executor.py` (150 ัััะพะบ)
- ะะปะฐัั `ToolExecutor` ะธะฝะบะฐะฟััะปะธััะตั ะปะพะณะธะบั ะฒัะฟะพะปะฝะตะฝะธั ะธะฝััััะผะตะฝัะพะฒ  
- ะะฑะฝะพะฒะปัะฝ `LLMNode` ะดะปั ะดะตะปะตะณะธัะพะฒะฐะฝะธั
- ะฃะดะฐะปะตะฝะพ 107 ัััะพะบ ะธะท `base.py`
- ะกะพะทะดะฐะฝะพ 10 unit-ัะตััะพะฒ

**ะะตะทัะปััะฐัั:**
- `LLMNode` ัะพะบััะธััะตััั ะฝะฐ ะบะพะฝัะธะณััะฐัะธะธ LLM
- `ToolExecutor` ะธะทะพะปะธัะพะฒะฐะฝ ะธ ัะตััะธััะตะผ
- ะัะต ัะตััั ะฟัะพัะพะดัั (85/85)
- ะัะฑะปะธัะฝัะน API ะฝะตะธะทะผะตะฝะตะฝ

```python
class ToolExecutor:
    def __init__(self, tools_map, result_handler):
        ...
    async def execute_tools(self, tool_calls, state) -> dict: ...

class LLMNode:
    def __init__(self, agent_id, tools):
        self.tool_executor = ToolExecutor(self.tools_map, self.handle_tool_result)
```

### ะัะธะพัะธัะตั: ะกะะะะะะ

#### 7.5. ~~ะฃัััะฐะฝะธัั ัะธะบะปะธัะตัะบะธะต ะธะผะฟะพััั~~ โ ะะซะะะะะะะ (2025-12-30)

**ะะตะฐะปะธะทะพะฒะฐะฝะพ:**
- ะกะพะทะดะฐะฝ ะฝะพะฒัะน ะผะพะดัะปั `state/context.py`
- ะคัะฝะบัะธะธ `get_current_state()` ะธ `set_tool_context()` ะฒัะฝะตัะตะฝั ะธะท `capabilities/base.py`
- ะะฑะฝะพะฒะปะตะฝั ะธะผะฟะพััั ะฒ 7 ัะฐะนะปะฐั:
  - `capabilities/base.py`
  - `nodes/product_owner.py`
  - `tools/deploy.py` (1 inline import)
  - `tools/infrastructure.py` (2 inline ะธะผะฟะพััะฐ)
  - `tools/admin.py` (2 inline ะธะผะฟะพััะฐ)
  - `tools/engineering.py` (1 inline import)
  - 2 ัะตััะพะฒัั ัะฐะนะปะฐ

**ะะตะทัะปััะฐัั:**
- ะฃะฑัะฐะฝั ะฒัะต ะธะผะฟะพััั ะฒะฝัััะธ ััะฝะบัะธะน (code smell)
- ะฃะปัััะตะฝะฐ ะผะพะดัะปัะฝะพััั ะธ ัะตััะธััะตะผะพััั
- ะัะต 159 unit ัะตััะพะฒ ะฟัะพัะพะดัั
- Lint ะธ format ะฟัะพะฒะตัะบะธ ััะฟะตัะฝั

```python
# ะะพ: ะธะผะฟะพัั ะฒะฝัััะธ ััะฝะบัะธะธ
def trigger_deploy(...):
    from ..capabilities.base import get_current_state  # ะฆะธะบะปะธัะตัะบะธะน ะธะผะฟะพัั
    state = get_current_state()

# ะะพัะปะต: ัะธัััะน ะธะผะฟะพัั ัะฒะตััั
from ..state.context import get_current_state

def trigger_deploy(...):
    state = get_current_state()
```

### ะัะธะพัะธัะตั: ะะะะะะ

#### 7.8. ~~ะะตะบะพะผะฟะพะทะธัะพะฒะฐัั worker.py~~ โ ะะซะะะะะะะ (2025-12-31)

**ะกัะฐััั**: โ ะะะะะะกะขะฌะฎ ะะซะะะะะะะ

**ะะตะฐะปะธะทะพะฒะฐะฝะพ:**
- ะกะพะทะดะฐะฝ ะฟะฐะบะตั `src/worker/` ะฒะผะตััะพ ะผะพะฝะพะปะธัะฝะพะณะพ `worker.py`
- ะะฐะทะฑะธัะพ ะฝะฐ 5 ัะตะปะตะฝะฐะฟัะฐะฒะปะตะฝะฝัั ะผะพะดัะปะตะน:
  - `main.py` โ ัะพัะบะฐ ะฒัะพะดะฐ ะธ ะพัะบะตัััะฐัะธั (30 ัััะพะบ)
  - `message_processor.py` โ ะพะฑัะฐะฑะพัะบะฐ ัะพะพะฑัะตะฝะธะน ัะตัะตะท LangGraph (313 ัััะพะบ)
  - `provisioner.py` โ ะพะฑัะฐะฑะพัะบะฐ provisioner triggers (142 ัััะพะบ)
  - `events.py` โ ะฟะตัะตััะปะบะฐ worker events (67 ัััะพะบ)
  - `utils.py` โ ััะธะปะธัั ะธ memory stats (33 ัััะพะบ)
- ะะฑะฝะพะฒะปะตะฝั ะธะผะฟะพััั ะฒ ัะตััะฐั
- ะัะต 159 unit ัะตััะพะฒ ะฟัะพัะพะดัั

**ะะตะทัะปััะฐัั:**
- โ worker.py: 535 ัััะพะบ โ 5 ะผะพะดัะปะตะน (**ะฒัะตะณะพ ~585 ัััะพะบ**, ะฝะธ ะพะดะธะฝ >315)
- โ ะคะฐะนะปะพะฒ >400 ัััะพะบ: **2** (ะฑัะปะพ 3, **-33%**)
- โ ะฃะปัััะตะฝะฐ ะผะพะดัะปัะฝะพััั ะธ ัะตััะธััะตะผะพััั
- โ ะะฐะถะดัะน ะผะพะดัะปั ัะปะตะดัะตั SRP

**ะัะณะพะดะฐ:**
- ะงะธัะต ัะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ
- ะัะพัะต ะฝะฐะนัะธ ะธ ะธะทะผะตะฝะธัั ะบะพะฝะบัะตัะฝัั ะปะพะณะธะบั
- ะะตะณัะต ัะตััะธัะพะฒะฐัั ะพัะดะตะปัะฝัะต ะบะพะผะฟะพะฝะตะฝัั
- ะะพััะธะณะฝัั ะฟัะพะณัะตัั ะบ ัะตะปะธ: 0 ัะฐะนะปะพะฒ >400 ัััะพะบ

#### 7.6. ~~ะะพะฑะฐะฒะธัั ัะธะฟะธะทะฐัะธั ะดะปั unsafe dict access~~ โ ะะซะะะะะะะ (2025-12-31)

**ะะตะฐะปะธะทะพะฒะฐะฝะพ:**
- ะกะพะทะดะฐะฝ `schemas/api_types.py` ั TypedDict ััะตะผะฐะผะธ:
  - `ServerInfo` โ ะธะฝัะพัะผะฐัะธั ะพ ัะตัะฒะตัะต
  - `AllocationInfo` โ ะธะฝัะพัะผะฐัะธั ะพะฑ ะฐะปะปะพะบะฐัะธะธ ะฟะพััะฐ
  - `ProjectInfo` โ ะธะฝัะพัะผะฐัะธั ะพ ะฟัะพะตะบัะต
  - `ProjectConfig` โ ะบะพะฝัะธะณััะฐัะธั ะฟัะพะตะบัะฐ
  - `RepoInfo` โ ะธะฝัะพัะผะฐัะธั ะพ ัะตะฟะพะทะธัะพัะธะธ
- ะะพะฑะฐะฒะปะตะฝั helper-ััะฝะบัะธะธ: `get_server_ip()`, `get_repo_url()`
- ะะฑะฝะพะฒะปะตะฝั ัะฐะนะปั ั ัะธะฟะธะทะธัะพะฒะฐะฝะฝัะผ ะดะพัััะฟะพะผ:
  - `tools/ports.py`
  - `tools/deploy.py`
  - `tools/devops_tools.py`
  - `workers/deploy_worker.py`
  - `subgraphs/devops.py`

**ะะตะทัะปััะฐัั:**
- โ Type hints ะดะปั API responses
- โ ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝัะต helper-ััะฝะบัะธะธ ะดะปั fallback ะปะพะณะธะบะธ
- โ ะฃะปัััะตะฝะฝะฐั IDE ะฟะพะดะดะตัะถะบะฐ ะธ ะฐะฒัะพะดะพะฟะพะปะฝะตะฝะธะต

#### 7.7. ~~ะะตัะธัั TODO/FIXME ะธะปะธ ัะดะฐะปะธัั~~ โ ะะซะะะะะะะ (2025-12-31)

**ะะตะฐะปะธะทะพะฒะฐะฝะพ:**
- `tools/deploy.py:183,229` โ ัะดะฐะปะตะฝั ะฝะตะฐะบััะฐะปัะฝัะต TODO (devops_subgraph ัะถะต ัะตะฐะปะธะทะพะฒะฐะฝ, Redis stream ะธัะฟะพะปัะทัะตััั ะบะพััะตะบัะฝะพ)
- `tools/infrastructure.py:98` โ **ัะตะฐะปะธะทะพะฒะฐะฝะฐ ะฟัะพะฒะตัะบะฐ ownership** ะฟะตัะตะด release_port
- `subgraphs/engineering.py:180` + `workers/engineering_worker.py:40,55` โ ะฟะตัะตะฝะตัะตะฝะพ ะฒ `docs/backlog.md` ("Engineering Pipeline: TesterNode & Worker Integration")

**ะะตะทัะปััะฐัั:**
- โ 0 TODO/FIXME ะฒ ะบะพะดะต langgraph
- โ ะะพะฑะฐะฒะปะตะฝะฐ security ะฟัะพะฒะตัะบะฐ ownership ะฒ release_port
- โ ะะพะปััะธะต ะทะฐะดะฐัะธ ะทะฐะดะพะบัะผะตะฝัะธัะพะฒะฐะฝั ะฒ backlog

---

## 8. ะัะตะดะปะฐะณะฐะตะผะฐั ะฐััะธัะตะบัััะฐ ะฟะพัะปะต ัะตัะฐะบัะพัะธะฝะณะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        CURRENT STATE                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  langgraph (14,588 ัััะพะบ, 185 ะฟะฐะบะตัะพะฒ, ansible-core)           โ
โ  โโโ LLM ะพัะบะตัััะฐัะธั                                            โ
โ  โโโ Provisioner (ะะ LLM!)                                     โ
โ  โโโ SSH ะพะฟะตัะฐัะธะธ (ะะ LLM!)                                    โ
โ  โโโ Ansible runner (ะะ LLM!)                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        TARGET STATE                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  langgraph (~10,000 ัััะพะบ, ~140 ะฟะฐะบะตัะพะฒ)                       โ
โ  โโโ LLM ะพัะบะตัััะฐัะธั                                            โ
โ  โโโ Nodes (ะฐะณะตะฝัั)                                             โ
โ  โโโ Tools (ะดะปั ะฐะณะตะฝัะพะฒ)                                        โ
โ  โโโ Subgraphs                                                  โ
โ                                                                  โ
โ  infrastructure-worker (ะฝะพะฒัะน, ~2,000 ัััะพะบ)                   โ
โ  โโโ Provisioner                                                โ
โ  โโโ SSH ะพะฟะตัะฐัะธะธ                                               โ
โ  โโโ Ansible runner                                             โ
โ  โโโ Recovery                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 9. ะะตััะธะบะธ ััะฟะตัะฐ

| ะะตััะธะบะฐ | ะัะปะพ | ะกะตะนัะฐั | ะฆะตะปั | ะกัะฐััั |
|---------|------|--------|------|--------|
| ะกััะพะบ ะบะพะดะฐ langgraph | 14,588 | **10,939** | <11,000 | โ |
| Python ะฟะฐะบะตัะพะฒ | 185 | **~140** | <145 | โ |
| Docker image size | ~800 MB | **597 MB** | <600 MB | โ |
| ะคะฐะนะปะพะฒ >400 ัััะพะบ | 6 | **2** | 0 | ๐ |
| ะะตัะพะดะพะฒ >50 ัััะพะบ | 6 | 4 | 0 | ๐ |
| Hardcoded ะฟััะตะน | 4 | **0** | 0 | โ |
| Inline ะธะผะฟะพััะพะฒ | 6 | **0** | 0 | โ |
| TODO/FIXME | 3+ | **0** | 0 | โ |

---

## 10. ะะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ

### ะคะฐะทะฐ 1: ะัะดะตะปะตะฝะธะต infrastructure-worker โ
1. โ ะกะพะทะดะฐัั `services/infrastructure-worker/`
2. โ ะะตัะตะฝะตััะธ `provisioner/` ะบะพะด
3. โ ะะฐัััะพะธัั Redis pub/sub ะดะปั ะฒัะทะพะฒะพะฒ
4. โ ะฃะฑัะฐัั ansible-core ะธะท langgraph
5. โ ะกะพะทะดะฐัั proxy node ะฒ langgraph
6. โ ะฃะดะฐะปะธัั ััะฐััะน provisioner ะบะพะด

### ะคะฐะทะฐ 2: ะะตัะฐะบัะพัะธะฝะณ ะฑะพะปััะธั ัะฐะนะปะพะฒ ๐
1. ~~ะะฐะทะฑะธัั `ProvisionerNode.run()` ะฝะฐ ะผะตัะพะดั~~ โ
2. ะัะดะตะปะธัั `ToolExecutor` ะธะท `LLMNode`
3. ~~ะฆะตะฝััะฐะปะธะทะพะฒะฐัั ะบะพะฝััะฐะฝัั~~ โ

### ะคะฐะทะฐ 3: Cleanup โณ
1. ะฃะฑัะฐัั wrapper-ััะฝะบัะธะธ
2. ะฃัััะฐะฝะธัั ัะธะบะปะธัะตัะบะธะต ะธะผะฟะพััั
3. ะะพะฑะฐะฒะธัั ัะธะฟะธะทะฐัะธั
4. ะะตัะธัั TODO/FIXME
