# Resource Management (–ó–∞–≤—Ö–æ–∑)

–ó–∞–≤—Ö–æ–∑ ‚Äî —É–∑–µ–ª LangGraph, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π —Ä–µ—Å—É—Ä—Å–∞–º–∏ —Å –∏–∑–æ–ª—è—Ü–∏–µ–π —Å–µ–∫—Ä–µ—Ç–æ–≤ –æ—Ç LLM.

## –ü—Ä–∏–Ω—Ü–∏–ø: LLM –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–∏–¥–∏—Ç —Å–µ–∫—Ä–µ—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    LangGraph State                          ‚îÇ
‚îÇ  (—ç—Ç–æ –≤–∏–¥–∏—Ç LLM)                                           ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  allocated_resources: {                                    ‚îÇ
‚îÇ      "telegram_bot": "handle_abc123",  ‚Üê handle, –Ω–µ —Ç–æ–∫–µ–Ω  ‚îÇ
‚îÇ      "server": "prod_vps_1"            ‚Üê –∏–º—è, –Ω–µ IP/SSH    ‚îÇ
‚îÇ  }                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  –ó–∞–≤—Ö–æ–∑ (—É–∑–µ–ª LangGraph)                    ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  LLM-—á–∞—Å—Ç—å:                                                ‚îÇ
‚îÇ  - –†–µ—à–∞–µ—Ç –ö–ê–ö–û–ô —Ä–µ—Å—É—Ä—Å –Ω—É–∂–µ–Ω                               ‚îÇ
‚îÇ  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç handle/–∏–º—è –≤ state                           ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Python-—á–∞—Å—Ç—å (–≤–Ω–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ LLM):                         ‚îÇ
‚îÇ  - –ß–∏—Ç–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ storage                      ‚îÇ
‚îÇ  - –ü–µ—Ä–µ–¥–∞—ë—Ç –≤ subprocess —á–µ—Ä–µ–∑ env vars                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Secrets Storage                           ‚îÇ
‚îÇ  project.config.secrets (PostgreSQL)                       ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  telegram_bots:                                            ‚îÇ
‚îÇ    handle_abc123:                                          ‚îÇ
‚îÇ      name: "@weather_bot"                                  ‚îÇ
‚îÇ      token: "123456:ABC..."  ‚Üê —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: PostgreSQL

–°–µ–∫—Ä–µ—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–æ–ª–µ `config.secrets` –º–æ–¥–µ–ª–∏ `Project` –∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ API:

```python
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ —á–µ—Ä–µ–∑ API
await api_client.save_project_secret(project_id, "TELEGRAM_TOKEN", "123456:ABC...")

# DevOps subgraph —á–∏—Ç–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ project_spec.config.secrets
secrets = project_spec.get("config", {}).get("secrets", {})
```

## –¢–∏–ø—ã —Å–µ–∫—Ä–µ—Ç–æ–≤

DevOps subgraph –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Ç—Ä–∏ —Ç–∏–ø–∞:

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|-----|----------|--------|
| `infra` | –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ | `DATABASE_URL`, `REDIS_URL` |
| `computed` | –í—ã—á–∏—Å–ª—è—é—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ | `APP_NAME`, `PORT` |
| `user` | –¢—Ä–µ–±—É—é—Ç—Å—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | `TELEGRAM_BOT_TOKEN`, `API_KEY` |

## –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç –ó–∞–≤—Ö–æ–∑

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | Handle –ø—Ä–∏–º–µ—Ä | –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
|-----------|---------------|-----------------|
| Telegram –±–æ—Ç—ã | `handle_abc123` | token, username |
| –°–µ—Ä–≤–µ—Ä—ã | `prod_vps_1` | IP, SSH key |
| API –∫–ª—é—á–∏ | `openai_main` | API key |
| –î–æ–º–µ–Ω—ã | `example.com` | Cloudflare credentials |

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (Server Management)

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—É—é —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º (Time4VPS).

1.  **Source of Truth**: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (`api` —Å–µ—Ä–≤–∏—Å).
    *   –§–æ–Ω–æ–≤—ã–π worker (`server_sync.py`) –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç Time4VPS API.
    *   –ù–æ–≤—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `discovered`.
    *   –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `missing`.

2.  **Ghost Servers & Filtering**:
    *   –°–µ—Ä–≤–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (–ª–∏—á–Ω—ã–µ –º–∞—à–∏–Ω—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤), –ø—Ä–æ–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `GHOST_SERVERS`.
    *   –í –±–∞–∑–µ –æ–Ω–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `is_managed=False`.
    *   Zavhoz –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `list_managed_servers`, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ `is_managed=True`.

## GitHub App & Secrets

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å GitHub (—Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ workflows) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GitHub App.

| Secret Name | –û–ø–∏—Å–∞–Ω–∏–µ | –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è |
|-------------|----------|--------------|
| `GH_APP_ID` | App ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Project-Factory-Keeper | GitHub Secrets |
| `GH_APP_PRIVATE_KEY` | Private Key (.pem) –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ JWT | GitHub Secrets |

**–õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞:**
- `GITHUB_APP_ID` ‚Üí `.env`
- Private Key ‚Üí `~/.gemini/keys/github_app.pem` (mount –≤ docker-compose)

**Production:**
- Secrets –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ CI/CD workflow
- –ü—É—Ç—å –Ω–∞ –ø—Ä–æ–¥–µ: `/opt/secrets/github_app.pem`

---

## üöß –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è: SOPS + AGE

> [!NOTE]
> –°–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç **–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é**, –Ω–æ –µ—â—ë –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.

–î–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SOPS + AGE:

```yaml
# secrets.yaml (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω SOPS)
telegram_bots:
    handle_abc123:
        name: "@weather_bot"
        token: ENC[AES256_GCM,data:...,iv:...,tag:...]

servers:
    prod_vps_1:
        host: ENC[AES256_GCM,data:...,iv:...,tag:...]
        ssh_key: ENC[AES256_GCM,data:...,iv:...,tag:...]
```

```bash
# –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞
export SOPS_AGE_KEY_FILE=~/.age/key.txt
sops -d secrets.yaml > /tmp/secrets.yaml
```

## –°–º. —Ç–∞–∫–∂–µ

- [secrets-vault-design.md](secrets-vault-design.md) ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
