# Docker Compose configuration for testing
# Optimized for fast test execution with minimal dependencies

services:
  # === Test Infrastructure ===

  db-test:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: orchestrator_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d orchestrator_test" ]
      interval: 2s
      timeout: 2s
      retries: 5
    tmpfs:
      - /var/lib/postgresql/data # Use tmpfs for faster test runs
    networks:
      - test-network

  redis-test:
    image: redis:7-alpine
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 2s
      timeout: 2s
      retries: 5
    networks:
      - test-network

  # === Service Tests ===

  api-test:
    build:
      context: .
      dockerfile: services/api/Dockerfile.test
      target: test
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@db-test:5432/orchestrator_test
      REDIS_URL: redis://redis-test:6379
      API_BASE_URL: http://mock-api:8000
      PYTHONPATH: /app
    depends_on:
      db-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - test-network
    volumes:
      - ./services/api/src:/app/src:ro
      - ./services/api/tests:/app/tests:ro
      - ./shared:/app/shared:ro

  langgraph-test:
    build:
      context: .
      dockerfile: services/langgraph/Dockerfile.test
      target: test
    environment:
      REDIS_URL: redis://redis-test:6379
      PYTHONPATH: /app
      # Mock API URL for tests
      API_BASE_URL: http://mock-api:8000
      # Mock OpenAI API key to avoid import errors (LLM instantiation at module level)
      OPENAI_API_KEY: sk-test-mock-key-for-unit-tests
    depends_on:
      redis-test:
        condition: service_healthy
    networks:
      - test-network
    volumes:
      - ./services/langgraph/src:/app/src:ro
      - ./services/langgraph/tests:/app/tests:ro
      - ./shared:/app/shared:ro

  scheduler-test:
    build:
      context: .
      dockerfile: services/scheduler/Dockerfile.test
      target: test
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@db-test:5432/orchestrator_test
      REDIS_URL: redis://redis-test:6379
      API_BASE_URL: http://mock-api:8000
      PYTHONPATH: /app
    depends_on:
      db-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - test-network
    volumes:
      - ./services/scheduler/src:/app/src:ro
      - ./services/scheduler/tests:/app/tests:ro
      - ./shared:/app/shared:ro

  telegram-bot-test:
    build:
      context: .
      dockerfile: services/telegram_bot/Dockerfile.test
      target: test
    environment:
      API_BASE_URL: http://mock-api:8000
      REDIS_URL: redis://redis-test:6379
      TELEGRAM_BOT_TOKEN: test-token
      PYTHONPATH: /app
    networks:
      - test-network
    volumes:
      - ./services/telegram_bot/src:/app/src:ro
      - ./services/telegram_bot/tests:/app/tests:ro
      - ./shared:/app/shared:ro

  workers-spawner-test:
    build:
      context: .
      dockerfile: services/workers-spawner/Dockerfile.test
      target: test
    environment:
      PYTHONPATH: /app/src:/app/shared
    networks:
      - test-network
    volumes:
      - ./services/workers-spawner/src:/app/src:ro
      - ./services/workers-spawner/tests:/app/tests:ro
      - ./services/workers-spawner/conftest.py:/app/conftest.py:ro
      - ./services/workers-spawner/pyproject.toml:/app/pyproject.toml:ro
      - ./shared:/app/shared:ro
    command: [ "pytest", "tests/", "-v", "--ignore=shared/" ]

  orchestrator-cli-test:
    build:
      context: .
      dockerfile: shared/cli/Dockerfile.test
      target: test
    environment:
      PYTHONPATH: /app/src:/app
      API_BASE_URL: http://mock-api:8000
    networks:
      - test-network
    # Note: No volumes mounted - all code is copied into image during build
    # This prevents module duplication and file path conflicts
    command: [ "pytest", "/app/shared/cli/tests", "/app/shared/tests", "-v", "-s" ]

networks:
  test-network:
    driver: bridge
