---
# Deploy Project Playbook
# Deploys a service-template based project via Docker Compose
#
# Required variables:
#   - project_name: Project name (kebab-case)
#   - repo_full_name: GitHub repo (org/repo)
#   - github_token: GitHub access token
#   - service_port: Main service port
#
# Optional variables:
#   - telegram_token: Telegram bot token (if tg_bot module)
#   - selected_modules: Comma-separated modules (default: backend)

- name: Deploy project via Docker Compose
  hosts: all
  gather_facts: no
  vars:
    project_dir: "/opt/services/{{ project_name }}"
    repo_url: "https://x-access-token:{{ github_token }}@github.com/{{ repo_full_name }}.git"
    # Convert project-name to project_name for database
    project_slug: "{{ project_name | replace('-', '_') }}"
    # Default modules if not specified
    modules: "{{ selected_modules | default('backend') }}"

  tasks:
    # ========================================
    # 1. Prepare Directory
    # ========================================
    - name: Ensure project directory exists
      file:
        path: "{{ project_dir }}"
        state: directory
        mode: '0755'

    # ========================================
    # 2. Clone/Update Repository
    # ========================================
    - name: Clone or update repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ project_dir }}"
        version: main
        force: yes
      register: git_result

    - name: Show clone result
      debug:
        msg: "Repository cloned/updated. Changed: {{ git_result.changed }}"

    # ========================================
    # 3. Create Environment Files
    # ========================================
    - name: Generate secure passwords
      set_fact:
        postgres_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
        app_secret_key: "{{ lookup('password', '/dev/null length=48 chars=ascii_letters,digits') }}"

    - name: Create main .env file
      copy:
        dest: "{{ project_dir }}/.env"
        content: |
          # Generated by Codegen Orchestrator DevOps
          # Project: {{ project_name }}
          # Deployed: {{ ansible_date_time.iso8601 | default('now') }}

          # Application
          ENVIRONMENT=production
          APP_ENV=production
          APP_NAME={{ project_name }}
          APP_SECRET_KEY={{ app_secret_key }}

          # Service Port (for external access)
          PORT={{ service_port }}

          # Docker Images (from GitHub Container Registry)
          BACKEND_IMAGE=ghcr.io/{{ repo_full_name }}-backend:latest
          TG_BOT_IMAGE=ghcr.io/{{ repo_full_name }}-tg-bot:latest
          FRONTEND_IMAGE=ghcr.io/{{ repo_full_name }}-frontend:latest
          NOTIFICATIONS_WORKER_IMAGE=ghcr.io/{{ repo_full_name }}-notifications-worker:latest

          # Database
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          POSTGRES_DB={{ project_slug }}
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD={{ postgres_password }}
          DATABASE_URL=postgresql+psycopg://postgres:{{ postgres_password }}@db:5432/{{ project_slug }}
          ASYNC_DATABASE_URL=postgresql+asyncpg://postgres:{{ postgres_password }}@db:5432/{{ project_slug }}

          # Redis
          REDIS_URL=redis://redis:6379

          # Backend API (for internal service communication)
          API_BASE_URL=http://backend:8000
          BACKEND_API_URL=http://backend:8000

          {% if telegram_token is defined and telegram_token %}
          # Telegram Bot
          TELEGRAM_BOT_TOKEN={{ telegram_token }}
          {% endif %}
        mode: '0600'

    - name: Create infra/.env.prod file
      copy:
        dest: "{{ project_dir }}/infra/.env.prod"
        content: |
          # Production environment overrides
          ENVIRONMENT=production
          DEBUG=false
        mode: '0600'

    # ========================================
    # 4. Login to GitHub Container Registry
    # ========================================
    - name: Login to GitHub Container Registry
      shell: |
        echo "{{ github_token }}" | docker login ghcr.io -u {{ repo_full_name.split('/')[0] }} --password-stdin
      register: login_result
      changed_when: login_result.rc == 0
      no_log: true

    # ========================================
    # 5. Open Firewall Port
    # ========================================
    - name: Open service port in UFW
      ufw:
        rule: allow
        port: "{{ service_port }}"
        proto: tcp
      ignore_errors: yes

    # ========================================
    # 6. Pull and Start Services
    # ========================================
    # Try to pull pre-built images from registry (for CI/CD deployments)
    - name: Pull Docker images from registry
      shell: |
        cd {{ project_dir }}
        docker compose -f infra/compose.base.yml -f infra/compose.prod.yml pull 2>&1
      register: pull_result
      ignore_errors: yes

    - name: Show pull result
      debug:
        msg: "Docker pull {{ 'succeeded' if pull_result.rc == 0 else 'failed - will build locally' }}"

    # If pull succeeded, start with prod config (pre-built images)
    - name: Start services with pre-built images
      shell: |
        cd {{ project_dir }}
        docker compose -f infra/compose.base.yml -f infra/compose.prod.yml up -d --remove-orphans
      register: compose_result
      when: pull_result.rc == 0

    # If pull failed, build and start locally (initial deployment)
    - name: Build and start services locally
      shell: |
        cd {{ project_dir }}
        docker compose -f infra/compose.base.yml -f infra/compose.dev.yml up -d --build --remove-orphans
      register: compose_result
      when: pull_result.rc != 0

    - name: Show compose result
      debug:
        msg: "Docker Compose {{ 'started with pre-built images' if pull_result.rc == 0 else 'built and started locally' }}"

    # ========================================
    # 7. Cleanup
    # ========================================
    - name: Prune unused Docker images
      command: docker image prune -f
      failed_when: false
      changed_when: false

    # ========================================
    # 8. Health Check
    # ========================================
    - name: Wait for services to start
      pause:
        seconds: 10

    - name: Check running containers
      shell: |
        cd {{ project_dir }}
        docker compose -f infra/compose.base.yml -f infra/compose.prod.yml ps --format json
      register: containers_result
      failed_when: false

    - name: Display deployment summary
      debug:
        msg:
          - "=========================================="
          - "Deployment Complete!"
          - "=========================================="
          - "Project: {{ project_name }}"
          - "Directory: {{ project_dir }}"
          - "Port: {{ service_port }}"
          - "Repository: {{ repo_full_name }}"
          - "=========================================="
