---
# Provision Software Playbook
# Stage 2: System Updates and Software Installation (Slow)
# Usage: ansible-playbook -i inventory/prod.ini playbooks/provision_software.yml -e "target_host=vps-267179"

- name: Provision Software (Updates & Docker)
  hosts: "{{ target_host | default('all') }}"
  become: true
  vars_files:
    - ../group_vars/provision_vars.yml
  
  pre_tasks:
    - name: Wait for server to be reachable
      wait_for_connection:
        timeout: 60
    
    - name: Gather facts
      setup:

  tasks:
    # ========================================
    # 1. System Updates
    # ========================================
    - name: Wait for any possibly running apt/dpkg processes
      shell: "while fuser /var/lib/dpkg/lock >/dev/null 2>&1 || fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done;"

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [system]

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
      tags: [system]

    # ========================================
    # 2. Essential Tools Installation
    # ========================================
    - name: Install essential packages
      apt:
        name: "{{ essential_packages }}"
        state: present
      tags: [packages]

    # ========================================
    # 3. Docker Installation
    # ========================================
    - name: Install Docker prerequisites
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
      tags: [docker]

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      tags: [docker]

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_facts['distribution_release'] }} stable"
        state: present
      tags: [docker]

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes
      tags: [docker]

    - name: Ensure Docker service is started and enabled
      systemd:
        name: docker
        state: started
        enabled: yes
      tags: [docker]

    # ========================================
    # 4. Firewall (UFW) Application Rules
    # ========================================
    # Note: UFW and SSH are already enabled in Stage 1
    
    - name: Allow HTTP through firewall
      ufw:
        rule: allow
        port: '80'
        proto: tcp
      tags: [firewall]

    - name: Allow HTTPS through firewall
      ufw:
        rule: allow
        port: '443'
        proto: tcp
      tags: [firewall]

    # ========================================
    # 5. System Configuration
    # ========================================
    - name: Set timezone
      timezone:
        name: "{{ timezone }}"
      tags: [system]

    - name: Set hostname
      hostname:
        name: "{{ server_hostname | default(inventory_hostname) }}"
      tags: [system]

    # ========================================
    # 6. Verification
    # ========================================
    - name: Verify Docker is running
      command: docker --version
      register: docker_version
      changed_when: false
      tags: [verify]

    - name: Verify UFW is active
      command: ufw status
      register: ufw_status
      changed_when: false
      tags: [verify]

    - name: Display verification results
      debug:
        msg:
          - "Docker version: {{ docker_version.stdout }}"
          - "UFW status: {{ ufw_status.stdout_lines[0] }}"
      tags: [verify]

  post_tasks:
    - name: Software provisioning complete
      debug:
        msg: "Server {{ inventory_hostname }} software installation complete!"
