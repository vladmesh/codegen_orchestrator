# Multi-stage Dockerfile for scaffolder testing

FROM python:3.12-slim AS base

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    && rm -rf /var/lib/apt/lists/*

# === Dependencies Stage ===
FROM base AS deps

# Install copier and test dependencies
RUN pip install --no-cache-dir \
    copier==9.4.1 \
    redis[hiredis]==5.0.1 \
    httpx==0.27.0 \
    structlog==24.1.0 \
    pyyaml==6.0.1 \
    pyjwt[crypto]==2.8.0 \
    pydantic==2.7.4 \
    pynacl==1.5.0 \
    pytest==8.3.4 \
    pytest-asyncio==0.24.0

# === Test Stage ===
FROM deps AS test

# Copy shared module
COPY shared /app/shared

# Copy scaffolder source
COPY services/scaffolder/src /app/src

# Tests will be mounted via volume for faster iteration

ENV PYTHONPATH=/app:/app/src

CMD ["pytest", "tests/service/", "-v"]
