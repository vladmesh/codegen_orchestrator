FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Copy dependency files
COPY services/infra-service/pyproject.toml /app/services/infra-service/
COPY shared/ /app/shared/
COPY services/infra-service/src/ /app/services/infra-service/src/

# Install dependencies
RUN pip install --no-cache-dir uv && \
    uv pip install --system -e /app/shared && \
    uv pip install --system "pytest" "pytest-asyncio" "pytest-mock" "fakeredis" && \
    uv pip install --system -e /app/services/infra-service

# Set pythonpath
ENV PYTHONPATH=/app

CMD ["pytest", "services/infra-service/tests", "-v"]
