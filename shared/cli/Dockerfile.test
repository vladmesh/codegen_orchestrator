# Multi-stage Dockerfile optimized for testing CLI

FROM python:3.12-slim AS base

WORKDIR /app

# === Test Dependencies Stage ===
FROM base AS test-deps

# Copy entire shared module (needed for pip install and tests)
COPY shared ./shared

# Explicitly copy tests (sometimes .dockerignore can be tricky)
# This ensures we definitely have shared/tests even if .dockerignore acts weird
COPY shared/tests ./shared/tests

# Install shared module (provides pyyaml, pydantic-settings, etc.)
RUN pip install --no-cache-dir ./shared

# Copy CLI dependency files
COPY shared/cli/pyproject.toml ./

# Install runtime + test dependencies
RUN pip install --no-cache-dir . && \
    pip install --no-cache-dir pytest pytest-asyncio pytest-cov structlog

# === Test Stage ===
FROM test-deps AS test

#Note: shared/ is already copied in test-deps stage, which includes shared/cli/src and shared/cli/tests

# Install CLI package in editable mode from shared/cli directory
WORKDIR /app/shared/cli
RUN pip install --no-cache-dir -e .

# Run tests from shared/cli and shared/tests directories
WORKDIR /app
CMD ["pytest", "shared/cli/tests", "shared/tests", "-v"]
